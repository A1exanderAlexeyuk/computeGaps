% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/compute_prevalence.R
\name{compute_prevalence_from_tsv}
\alias{compute_prevalence_from_tsv}
\title{Compute prevalence of diagnostic tests/procedures around cohort index from a TSV specification}
\usage{
compute_prevalence_from_tsv(
  conn,
  cdm_schema,
  cohort_schema,
  cohort_table,
  tsv_path,
  cohort_definition_id = NULL
)
}
\arguments{
\item{conn}{A DatabaseConnector connection object (DBI connection) to the CDM database.}

\item{cdm_schema}{The schema name where CDM tables live (e.g., "omop_cdm").}

\item{cohort_schema}{The schema name where the cohort table lives.}

\item{cohort_table}{The cohort table name (standard columns: subject_id, cohort_start_date \link{, cohort_definition_id}).}

\item{tsv_path}{Path to the TSV file with specifications.}

\item{cohort_definition_id}{Optional integer; if provided, will filter the cohort table by this ID.}
}
\value{
A tibble with the columns described above.
}
\description{
This function reads a TSV that specifies pairs of concept_id_1 -> concept_id_2 relations
and associated metadata (including a time window around index) and computes, for each row,
how many cohort patients had the specified concept (concept_id_2) recorded in the appropriate
OMOP CDM domain table within the specified window relative to cohort_start_date.
}
\details{
The TSV is expected to contain the following columns (case sensitive):
\itemize{
\item cohortname: a label for the cohort (used in the output only)
\item concept_id_1: not used in the computation, retained for completeness
\item relationship_id: not used in the computation, retained for completeness
\item concept_id_2: OMOP standard concept id for the diagnostic test/procedure/etc
\item omop_object_domain: OMOP domain name for concept_id_2 (e.g., Measurement, Procedure, Observation, Drug, Condition, Device)
\item object_custom_name: human-readable label for the concept/object
\item object_custom_code: optional code, not used in the computation
\item predicate_metadata: JSON string with keys including "Workflow stage", "days_around_index_1", "days_around_index_2", and optionally "time_gap_in_days".
}

The output contains one row per input row with the following columns:
\itemize{
\item cohortname
\item omop_object_domain
\item object_custom_name
\item Workflow stage (from predicate_metadata)
\item patient_count (distinct patients with at least one qualifying record)
\item n_patients (distinct patients in the cohort table)
\item n_patients_with_op (alias of patient_count for clarity)
}

Notes/assumptions:
\itemize{
\item The cohort table should contain only the cohort of interest OR you can supply a specific
cohort_definition_id to filter within a shared cohort table.
\item The time window is applied relative to cohort_start_date inclusive: \link{days_around_index_1, days_around_index_2}.
\item Exact concept_id matching is used (no descendant expansion).
}
}
